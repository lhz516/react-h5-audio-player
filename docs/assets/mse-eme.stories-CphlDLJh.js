import{r as k,j as i}from"./iframe-DWWJ7iW9.js";import{H as E}from"./index-BX3YaWGJ.js";import{S}from"./utils-MesXHYS8.js";import"./preload-helper-D9Z9MdNV.js";const f=11,d=5,b=f*d,B="//localhost:1337/audio-cenc/long_input_44100_192k_",U=[...Array(f)].map((r,e)=>`${("00"+e).slice(-3)}.mp4`),M=[...Array(f)].map((r,e)=>`${("00"+e).slice(-3)}_cenc.mp4`),C='audio/mp4; codecs="mp4a.40.2"',{KEY:_,KID:L}={KEY:"7f412f0575f44f718259beef56ec7771",KID:"2fef8ad812df429783e9bf6e5e493e53"},A=[{initDataTypes:["cenc"],audioCapabilities:[{contentType:C}]}];let m;function v(r,e,t){return m||(m=navigator.requestMediaKeySystemAccess(e,t).then(n=>n.createMediaKeys()).then(n=>r.setMediaKeys(n)),m)}function w(r){let e="";const t=new Uint8Array(r);for(let n=0;n<t.length;n++)e+=String.fromCharCode(t[n]);return e}function O(r){const e=new ArrayBuffer(r.length),t=new Uint8Array(e);for(let n=0;n<r.length;n++)t[n]=r.charCodeAt(n);return e}function g(r){let e="";for(let t=0;t<r.length;t+=2)e+=String.fromCharCode(parseInt(r.substr(t,2),16));return window.btoa(e).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function D(r){const e=JSON.parse(w(r.message)),t=[];t.push({kty:"oct",alg:"A128KW",kid:g(L),k:g(_)});const n=JSON.stringify({keys:t,type:e.type});r.target.update(O(n))}class T extends k.PureComponent{player=k.createRef();mediaSource=null;loadingChunk=!1;chunks=[];whenBufferUpdateEndCallbacks=[];sourceBuffer=null;state={audioSrc:"",srcDuration:void 0};onEncrypted(e){const t=e.target;v(t,"org.w3.clearkey",A).then(()=>{const n=t.mediaKeys.createSession();return n.addEventListener("message",D),n.generateRequest(e.initDataType,e.initData)}),this.props.onEncrypted(e)}onSeek(e,t){const n=this.chunks,o=n.every((a,s)=>a.segmentTime*s>t||a.data);return new Promise(a=>{if(o)e.currentTime=t,this.checkBufferLoad(),a();else{e.paused||e.pause();const s=n.find((h,u)=>h.segmentTime*(u+1)>t),c=s.segmentTime*s.chunkIndex;this.onTimeUpdate(),this.whenBufferUpdateEndCallbacks.push(()=>{e.currentTime=t,this.checkBufferLoad(),e.paused?e.play().then(a):a()});const p=c;this.loadChunk(s,p)}})}onChunkLoad(){this.loadingChunk=!1,this.whenBufferUpdateEndCallbacks.forEach(e=>e()),this.whenBufferUpdateEndCallbacks=[]}checkBufferLoad(){if(this.loadingChunk)return;const{sourceBuffer:e,mediaSource:t}=this,n=this.chunks,o=n.every(u=>u.data);if(o&&t.readyState==="open"&&t.endOfStream(),o)return;const a=this.player.current.audio.current,s=n.findIndex((u,y)=>d*y>a.currentTime&&!u.data),c=s*d;c-a.currentTime<d&&!e.updating&&t.readyState==="open"&&this.loadChunk(n[s],c)}onTimeUpdate(){this.state.audioSrc!==S&&this.checkBufferLoad()}setSong(e){this.chunks=e.map((n,o)=>({name:B+n,data:null,segmentTime:d,chunkIndex:o})),this.mediaSource=new MediaSource;const t=URL.createObjectURL(this.mediaSource);this.setState({audioSrc:t,srcDuration:b}),this.mediaSource.addEventListener("sourceopen",()=>{const n=this.player.current.audio.current;URL.revokeObjectURL(n.src),this.sourceBuffer=this.mediaSource.addSourceBuffer(C),this.loadChunk(this.chunks[0],0),this.sourceBuffer.addEventListener("updateend",()=>{this.onChunkLoad()})})}loadChunk(e,t){if(!e){this.mediaSource.endOfStream();return}this.loadingChunk=!0,fetch(e.name).then(n=>n.arrayBuffer()).then(n=>{e.data=n,typeof t<"u"&&(this.sourceBuffer.timestampOffset=t),this.sourceBuffer.appendBuffer(n)})}render(){return i.jsxs("div",{children:[i.jsx("button",{onClick:()=>this.setSong(U),children:"Play non encrypted audio"}),i.jsx("button",{onClick:()=>this.setSong(M),children:"Play encrypted audio"}),i.jsx("button",{onClick:()=>this.setState({audioSrc:S,srcDuration:void 0}),children:"Play normal progressive download audio"}),i.jsx(E,{autoPlayAfterSrcChange:!1,ref:this.player,src:this.state.audioSrc,mse:{srcDuration:this.state.srcDuration,onEcrypted:e=>this.onEncrypted(e),onSeek:(e,t)=>this.onSeek(e,t)},onListen:()=>this.onTimeUpdate(),listenInterval:250})]})}}T.__docgenInfo={description:"",methods:[{name:"onEncrypted",docblock:null,modifiers:[],params:[{name:"ev",optional:!1,type:{name:"MediaEncryptedEvent",alias:"MediaEncryptedEvent"}}],returns:{type:{name:"void"}}},{name:"onSeek",docblock:null,modifiers:[],params:[{name:"audio",optional:!1,type:{name:"HTMLAudioElement",alias:"HTMLAudioElement"}},{name:"time",optional:!1,type:{name:"number"}}],returns:{type:{name:"Promise",elements:[{name:"void"}],raw:"Promise<void>"}}},{name:"onChunkLoad",docblock:null,modifiers:[],params:[],returns:{type:{name:"void"}}},{name:"checkBufferLoad",docblock:null,modifiers:[],params:[],returns:{type:{name:"void"}}},{name:"onTimeUpdate",docblock:null,modifiers:[],params:[],returns:{type:{name:"void"}}},{name:"setSong",docblock:null,modifiers:[],params:[{name:"chunkNames",optional:!1,type:{name:"Array",elements:[{name:"string"}],raw:"string[]"}}],returns:{type:{name:"void"}}},{name:"loadChunk",docblock:null,modifiers:[],params:[{name:"next",optional:!1,type:{name:"ChunkData",alias:"ChunkData"}},{name:"timestampOffset",optional:!1,type:{name:"number"}}],returns:{type:{name:"void"}}}],displayName:"MediaSourcePlayer"};const{action:I}=__STORYBOOK_MODULE_ACTIONS__,j={title:"MSE-EME",component:E},l={render:()=>i.jsx(T,{onEncrypted:I("onEncrypted")}),name:"MSE-EME"};l.parameters={...l.parameters,docs:{...l.parameters?.docs,source:{originalSource:`{
  render: () => <MediaSourcePlayer onEncrypted={action('onEncrypted')} />,
  name: 'MSE-EME'
}`,...l.parameters?.docs?.source}}};const H=["MseEme"];export{l as MseEme,H as __namedExportsOrder,j as default};
